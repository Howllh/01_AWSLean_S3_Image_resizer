# AWS-Learning-Practice

# 概要
画像がS3にアップロードされたら、Lambdaが自動でサイズを小さくして、別の場所に保存する
![S3作成イメージ](01_s3_image_resizer/01_Picture/Pic_01.png)

# 利用サービス
AWS S3  
AWS Lambda

# 流れ
1. User: 画像をSource Bucket(入力用)にアップロード。
1. S3: アップロードを検知してLambdaを起動(Trigger)。
1. Lambda: 画像を読み込み、リサイズ処理を行う(Python+Pillowライブラリ)。
1. Lambda: リサイズした画像をTarget Bucket(出力用)に保存。

# 作業準備
## AWS　アカウント作成
### AWS IAMユーザー作成
※ルートユーザー作成済、IAMユーザーの作成手順
1. ルートユーザーでログインする
1. IAMダッシュボードへ移動し、AWSコンソールの検索窓で「IAM」と検索し、サービスを開きます
1. 左メニューの「ユーザー」をクリック → 「ユーザーの作成」 オレンジ色のボタンをクリック
1. ユーザー名: 「HaoAdmin」と入力
1. 「AWSマネジメントコンソールへのユーザーアクセスを提供する」にチェック✅を入れる
1. コンソールパスワード: 「カスタムパスワード」を選び、自分でパスワードを設定（または自動生成）
1. 「次へ」をクリック
1. 許可の設定をする。
    * 許可のオプション: 「ポリシーを直接アタッチする」 を選択
    * 許可ポリシーのリストから: 検索窓に Admin と入力
    * 「AdministratorAccess」というポリシーが表示されるので、チェック✅を入れる  
        ※ こちらのポリシーは、「請求情報以外はほぼ何でもできる管理者権限」です。
1. 「次へ」をクリック
1. 内容を確認して 「ユーザーの作成」 をクリック
1. ログイン情報の保存:
    * .csv ファイルをダウンロードするボタンが表示され、ダウンロードして保管する

### セキュリティー設定（二段階認証MFA）
* IAMユーザーでMFA設定:
    1. 作成したIAMユーザーでログインし直す
    2. 右上のユーザー名をクリック → 「セキュリティ認証情報」
    3. 「多要素認証 (MFA)」の 「MFA デバイスの割り当て」 から設定
    4. デバイスを識別できるように、「デバイス名」を入力(自分のMacを利用したので、MyMacで入力した)
    5. パスキーを選択し、MacBookの指紋認証を行う
    6. 設定完了

## Githubリポジトリの作成
1. VS Code経由で、ローカルに連携
1. 略

## S3バケット作成（入力用と出力用）
1. AWSコンソールで S3 を開く
1. 「バケットを作成」をクリック
1. 「バケット名」に「hao-image-resize-input」
1. 他の設定は、デフォルトのままで問題なし
1. 同様に「hao-image-resize-output」のバケットを作成

## IAMロールの作成（権限設定）
概要:  
　　Lambdaが「S3から画像を読み込む」「S3に画像を書き込む」「ログを出す」ための許可証（ロール）を作ります。

手順：  
1. AWSコンソールで IAM を開く -> ロール -> ロールを作成
1. ステップ1:
    * 信頼されたエンティティタイプ: AWSのサービス
    * ユースケース: Lambda を選択して「次へ」
1. ステップ2:
    * 許可ポリシーで以下を検索してチェックを入れる
        * AWSLambdaBasicExecutionRole (ログ出力用)
        * AmazonS3FullAccess(S3操作用)  
        ※ 本来は特定のバケットのみに絞るのがベストですが、練習なのでFullAccessで進みます。
1. ステップ3:
    * 名前に「LambdaResizeRole」を入力し
    * 「ロールを作成」を押下

## Lambda関数の作成
1. AWSコンソールで Lambda を開く -> 関数の作成
1. 「一から作成」を選択
1. 関数名: ImageResizerFunction
1. ランタイム: Python 3.14 (または最新のもの)
1. アーキテクチャ: x86_64
1. 「デフォルトの実行ロールを変更」を展開 -> 既存のロールを使用する -> 先ほど作った LambdaResizeRole を選択
1. 「関数の作成」をクリック

## コードの作成とライブラリの準備（ローカル作業）
1. ローカルの aws-image-resizer フォルダで lambda_function.py を作成する
1. コードを入れる
1. AWS用ライブラリ (Pillow) のインストール
    Mac用のPillowではなく、Linux (x86_64) 用のPillow を現在のフォルダにインストールします。  
    * ターミナルで以下のコマンドを1行で実行してください。（コピーして貼り付けてください）  
    <pip3 install Pillow --target . --platform manylinux2014_x86_64 --only-binary=:all: --python-version 3.12>
1. 01_s3_image_resizer フォルダの中に、lambda_function.py と一緒に PIL フォルダ（ライブラリ）が並んでいることを確認

## ZIP圧縮
1. 「01_s3_image_resizer」直下にあるすべてのファイルを圧縮する
1. ファイル名を「deploy.zip」に変更

## AWSへアップロード
1. AWS Lambdaの画面（ImageResizerFunction）を開く
1. 画面真ん中あたりの 「コード」 タブを見る
1. 右側の 「アップロード元」 ボタン → 「.zipファイル」 を選択
1. さっき作った deploy.zip を選んで「保存」
1. 画面に「関数 ... が正常に更新されました」と出て、ソースコードエディタの左側に PIL などのフォルダが表示されることを確認

## トリガーの設定（S3 → Lambda）
1. Lambda画面の上部にある図（関数の概要）の左側にある 「+ トリガーを追加」 をクリック
1. ソースを選択: プルダウンから S3 を選択
1. バケット: 作った 「入力用バケット」（...-input の方）を選択
1. イベントタイプ: 「すべてのオブジェクト作成イベント」を選択
1. サフィックス: .jpg と入力
1. 「私は、入力と出力の両方に同じ S3 バケットを使用することは推奨されておらず、この設定により、再帰呼び出しが生じ、それに伴い Lambda の使用量増加、コスト増大の可能性があることを了承します。」にチェックを入れる
1. 右下の 「追加」 ボタンをクリック

## テスト
1. AWSコンソール で S3の画面を別タブで開きます
1. 「入力用バケット（input）」 を開きます
1. 適当な 画像ファイル（.jpg） をアップロードします
1. アップロード完了後、「出力用バケット（output）」 の方に移動して中身を確認します

## 実行失敗（トラブルシューティング）
エラー内容が cannot import name '_imaging' from 'PIL' というものです。  
🕵️‍♂️ 原因：Mac語とLinux語の違い  
このエラーは、「画像処理のエンジンの部品（_imaging）が、Mac用（Darwin）のままになっているため、Linux（AWS）で動かない」 という状態です。

おそらく、先ほどのコマンド（pip install ... --platform ...）がうまくいっていなかったので、Mac版が混ざってしまったか、古いファイルが残っていた可能性が高いです。

解決策１：  
1. フォルダの大掃除.
    Finderで 01_s3_image_resizer フォルダに、lambda_function.py だけが残る状態にします
2. 再度ダウンロードしたけど、ダメだった。

解決策２：
Pythonバージョンを「3.12」に統一する

### 質問
* 料金について、かかりますか？
今回の練習範囲なら、ほぼ間違いなく0円です。
AWSには「無料利用枠」があり、今回の規模ならその枠内に余裕で収まります。
Lambda: 月に100万回のリクエスト、40万GB秒の実行時間が無料（永久無料枠）。今回数回テストしただけなので 0円。
S3: 最初の12ヶ月は5GBまで無料。画像数枚なら数MBなので 0円。
CloudWatch Logs: 5GBまで無料。テキストログだけなら 0円。

2. 安全性について
今のままでも直ちに危険というわけではありませんが、「練習が終わったら片付ける（削除する）」 のが、セキュリティ的にもお財布的にも 100% 安全 な方法です。

放置のリスク:

万が一、誰かがErthyさんのバケット名を知って大量の画像を送りつけてきた場合、Lambdaが勝手に動きまくって料金が発生する可能性があります。

作成したIAMロール（許可証）が、将来的に悪用されるリスクをゼロにするためにも、使わない権限は消すのが鉄則です。

